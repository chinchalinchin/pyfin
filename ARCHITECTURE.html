
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Architecture &#8212; scrilla  documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Development" href="DEVELOPMENT.html" />
    <link rel="prev" title="Usage" href="USAGE.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="architecture">
<h1>Architecture<a class="headerlink" href="#architecture" title="Permalink to this heading">¶</a></h1>
<p>TODO: describe architecture</p>
<section id="memory">
<h2>“Memory”<a class="headerlink" href="#memory" title="Permalink to this heading">¶</a></h2>
<p>TODO: explain purpose of memory.json</p>
</section>
<section id="cache">
<h2>Cache<a class="headerlink" href="#cache" title="Permalink to this heading">¶</a></h2>
<section id="example">
<h3>Example<a class="headerlink" href="#example" title="Permalink to this heading">¶</a></h3>
<p>In a typical invocation, <em>scrilla</em> will filter the user input through several layers of caching before attempting to make an API call. For example, if a user enters the command</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>scrilla risk-profile ALLY BX SONY -start <span class="m">2022</span>-01-01 -end <span class="m">2022</span>-06-01
</pre></div>
</div>
<p>Then the following flow will execute,</p>
<p><img alt="" src="https://chinchalinchin.github.io/scrilla/assets/cache_architecture.png" /></p>
<p>First, <code class="docutils literal notranslate"><span class="pre">scrilla.main</span></code> will parse and pass the arguments off to <code class="docutils literal notranslate"><span class="pre">scrilla.analysis.models</span></code>. <code class="docutils literal notranslate"><span class="pre">scrilla.analysis.models</span></code> will instruct the <code class="docutils literal notranslate"><span class="pre">ProfileCache</span></code> and <code class="docutils literal notranslate"><span class="pre">CorrelationCache</span></code> to search previous calculations for the current calculation. These caches will check an internal <code class="docutils literal notranslate"><span class="pre">dict</span></code> kept in memory for frequently assessed data; this is why each cache is implemented as a singleton: all instances of a given type of cache refer to the same instance, i.e. only one instance of each Cache can be created; this is so all references to a cache will in turn refer to the same internal cache.</p>
<p>If the result is not found in the internal cache, the <code class="docutils literal notranslate"><span class="pre">ProfileCache</span></code> and <code class="docutils literal notranslate"><span class="pre">CorrelationCache</span></code> will query the datastore. Either <strong>SQLite</strong> or <strong>DynamoDB</strong> will be used for the persistence layer, depending on the value of <code class="docutils literal notranslate"><span class="pre">scrilla.settings.CACHE_MODE</span></code>, which is in turn configured by the value of the <code class="docutils literal notranslate"><span class="pre">CACHE_MODE</span></code> environment variable. If this query returns the calculation, the flow halts and the result is passed back to the user.</p>
<p>If the query doesn’t return a result, <code class="docutils literal notranslate"><span class="pre">scrilla.analysis.models</span></code> will need to calculate the result, so it will request price data from <code class="docutils literal notranslate"><span class="pre">scrilla.services</span></code>.</p>
<p>Similar to the relationship between <code class="docutils literal notranslate"><span class="pre">scrilla.analysis.models</span></code> and the caches, <code class="docutils literal notranslate"><span class="pre">ProfileCache</span></code> and <code class="docutils literal notranslate"><span class="pre">CorrelationCache</span></code>, <code class="docutils literal notranslate"><span class="pre">scrilla.services</span></code> will instruct the <code class="docutils literal notranslate"><span class="pre">PriceCache</span></code> and <code class="docutils literal notranslate"><span class="pre">InterestCache</span></code> to search for the requested data. Each cache will check an internal <code class="docutils literal notranslate"><span class="pre">dict</span></code> where it stores frequently assessed data in memory. If a result is found, the program halts and returns the result to the user. If the internal cache returns nothing, <code class="docutils literal notranslate"><span class="pre">PriceCache</span></code> and <code class="docutils literal notranslate"><span class="pre">InterestCache</span></code> will query the datastore, either <strong>SQLite</strong> or <strong>DynamoDB</strong> as previously mentioned. If the result is found, the program halts and reutnrs the ressult to the user. If the query does not return a result, all of the caches have been exhausted, so <code class="docutils literal notranslate"><span class="pre">scrilla.services</span></code> will finally query the API service that acts as the source of truth for that particular piece of data (i.e., price data is retrieved from <strong>AlphaVantage</strong>, interest data is retrieved from the <strong>US Treasury</strong>, etc.)</p>
<p>Once the result is returned from the external API, the data will be persisted at every level as it flows back towards the user: <code class="docutils literal notranslate"><span class="pre">PriceCache</span></code> and <code class="docutils literal notranslate"><span class="pre">InterestCache</span></code> will save the result in their internal cache and upsert the data into the persistence layer. After <code class="docutils literal notranslate"><span class="pre">scrilla.anaylsis.models</span></code> receives the price data and calculates the relevant statistics, it will pass the results to <code class="docutils literal notranslate"><span class="pre">CorrelationCache</span></code> and <code class="docutils literal notranslate"><span class="pre">ProfileCache</span></code>, which will in turn save the results to the internal cache and then upsert the data into the persistence layer.</p>
<p>Once the cache is hydrated with data, any subsequent invocations that rely on the same data or calculations will hit the cache.</p>
</section>
<section id="memory-json">
<h3>memory.json<a class="headerlink" href="#memory-json" title="Permalink to this heading">¶</a></h3>
<p><em>memory.json</em> is a file kept in the installation’s <em>/data/common/</em> directory that contains flags to inform the application it has already executed certain actions, so it does not need to perform them again. With respect to the caches, this file has information about whether or not the cache tables have been initialized. Everytime one of the cache classes is instantiated, the cache will attempt to provision the tables in the persistence layer. This can be a costly operation, in terms of response time, especially since it only needs to be performed the first time the application executes. Therefore, once these tables are provisioned, the <em>memory.json</em> will be updated to reflect this information. Once the flags for the cache tables are set to <code class="docutils literal notranslate"><span class="pre">True</span></code>, the cache classes will skip the table provisioning step any time a new cache class is instantiated.</p>
<p><strong>NOTE</strong>: Even though the cache classes are singletons, their <code class="docutils literal notranslate"><span class="pre">__init__</span></code> methods are still invoked whenever they are instantiated, even if a previous instance exists. This is by design due to the fact the cache can be cleared via the <code class="docutils literal notranslate"><span class="pre">scrilla.files</span></code> module, i.e. the tables are dropped. In this case, the cache will need to re-create the tables in the persistence layer.</p>
</section>
</section>
<section id="static">
<h2>Static<a class="headerlink" href="#static" title="Permalink to this heading">¶</a></h2>
<section id="id1">
<h3>memory.json<a class="headerlink" href="#id1" title="Permalink to this heading">¶</a></h3>
</section>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">scrilla</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="OVERVIEW.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="SETUP.html">Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="CONFIGURATION.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="USAGE.html">Usage</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Architecture</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#memory">“Memory”</a></li>
<li class="toctree-l2"><a class="reference internal" href="#cache">Cache</a></li>
<li class="toctree-l2"><a class="reference internal" href="#static">Static</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="DEVELOPMENT.html">Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="DEPLOYMENT.html">Deployment</a></li>
<li class="toctree-l1"><a class="reference internal" href="APPENDIX.html">Appendix</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="USAGE.html" title="previous chapter">Usage</a></li>
      <li>Next: <a href="DEVELOPMENT.html" title="next chapter">Development</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2021, Grant Moore.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 5.0.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="_sources/ARCHITECTURE.md.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>