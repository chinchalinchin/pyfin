version: 2.1

commands:
  install:
    description: install build dependencies
    steps:
      - run:
          name: dependency installation
          command: pip install twine setuptools build
  build:
    description: compress and build python package
    steps:
      - run:
          name: artifact build
          command: python -m build
  upload:
    description: upload package artifacts to PyPi
    steps:
      - run:
          name: artifact upload
          command: twine upload -u $PYPI_USERNAME -p $PYPI_PASSWORD dist/*
  commit_version:
    description: commit new version to git
    steps:
      - run:
          name: commit version
          command: |
              git config user.email "chinchalinchin@gmail.com"
              git config user.name "CircleCi Bot"
              git add . 
              git commit -m "Pipeline Build Version $(cat ./src/scrilla/version.txt)"
  push_and_merge_from_micro:
    description: push new micro version number to GitHub
    steps:
      - run: 
          name: push micro version
          command: |
            git push --set-upstream origin pypi/micro-update
            git checkout develop/main
            git merge pypi/micro-update
            git push --set-upstream origin develop/main

  push_and_merge_from_minor:
    description: push new minor version number to GitHub
    steps:
      - run:
          name: push minor version
          command: |
              git push --set-upstream origin pypi/minor-update
              git checkout develop/main
              git merge pypi/minor-update
              git push --set-upstream origin develop/main
  
  push_and_merge_from_major:
    description: push new major version number to GitHub
    steps:
      - run:
          name: push major version
          command: |
            git push --set-upstream origin pypi/major-update
            git checkout develop/main
            git merge pypi/major-update
            git push --set-upstream origin develop/main
  
jobs:
  pypi_micro_update:
    docker:
      - image: cimg/python:3.9.6
    steps:
      - checkout
      - install
      - run:
          name: iterate micro version
          command: |
            python ./scripts/circleci/iterate_version.py micro
      - build
      - upload
      - commit_version
      - push_and_merge_from_micro

  pypi_minor_update:
    docker: 
      - image: cimg/python:3.9.6
    steps:
      - checkout
      - install
      - run:
          name: iterate minor version
          command: | 
            python ./scripts/circleci/iterate_version.py minor
      - build
      - upload
      - commit
      - push_and_merge_from_minor

  pypi_major_update:
    docker: 
      - image: cimg/python:3.9.6
    steps:
      - checkout 
      - install
      - run:
          name: iterate major version
          command: |
            python ./scripts/circleci/iterate_version.py major
      - build
      - upload
      - commit
      - push_and_merge_from_major

workflows:
  version: 2
  build_and_push:
    jobs:
      - pypi_micro_update:
          filters:
            branches:
              only:
                - pypi/micro-update
      - pypi_minor_update:
          filters: 
            branches:
              only:
                - pypi/minor-update
      - pypi_major_update:
          filters:
            branches:
              only:
                - pypi/major-update